#!/bin/bash

declare profileDir="$HOME/.config/chromium";

[[ -d "${profileDir}" ]] || {
  echo "No Google-Chrome profile found in ${profileDir}!";
  exit 1;
}

[ -x $(which profile-cleaner) ] || {
  echo "Profile-Cleaner Tool not installed/found!";
  exit 1;
}

echo
echo "Quitting all running chromium-browser processes:"
killall -e --wait $(which chromium-browser /snap/chromium/*/usr/lib/chromium-browser/chrome)

echo
echo "Searching profiles and running profile-cleaner:"
echo
find "${profileDir}" \( -name "*Profile*" -o -name "Default" \) -type d -prune ! -name 'Profile~Backups' -print0 | while IFS= read -r -d '' path;
do
   prefsFile=${path}/Preferences;

   if [[ ! -f "$prefsFile" ]];
   then
        echo "Missing preferences file (${path})";
        continue;
   fi

   echo "-----------------------------------------------------------";
   echo "Profile: ${path}";
   echo "-----------------------------------------------------------";
   echo
   echo "Checking for left dead lock-files.";
   find "${profileDir}" -type f -name 'SingletonLock' -delete;

   echo "Running profile-cleaner ...";
   profile-cleaner c -p "${profileDir}";
done

echo;
echo "Done.";
