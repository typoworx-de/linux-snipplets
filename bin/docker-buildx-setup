#!/bin/bash

network='host'
buildkitVersion='latest'
image="moby/buildkit:${buildkitVersion:-latest}"

echo "Pruning existing builder instances ...";
docker builder ls | \
  grep -Po '^[^ ]+' | \
  tail -n+2 | \
  grep -v 'default' | \
  xargs -l1 -I{} docker builder rm --force {} \
;

echo
echo "Pruning caches ...";
docker builder prune --all --force;

instance=$(
  docker buildx create \
    --use --bootstrap \
    --driver docker-container  \
    --driver-opt network="${network:-host}" \
    --driver-opt image="${image}" \
    --buildkitd-flags '--allow-insecure-entitlement security.insecure' \
    --config /etc/buildkit/buildkitd.toml
);

exit $?
