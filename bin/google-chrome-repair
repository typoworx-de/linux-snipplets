#!/bin/bash

declare profileDir="$HOME/.config/google-chrome";

[[ -d "${profileDir}" ]] || {
  echo "No Google-Chrome profile found in ${profileDir}!";
  exit 1;
}

[ -x $(which profile-cleaner) ] || {
  echo "Profile-Cleaner Tool not installed/found!";
  exit 1;
}

echo
echo "Quitting all running google-chrome processes ..."
killall $(which google-chrome) --wait
killall /opt/google/chrome/chrome --wait

#Profile~Backups
find "${profileDir}" \( -name "*Profile*" -o -name "Default" \) -type d -prune ! -name 'Profile~Backups' -print0 | while IFS= read -r -d '' path;
do
   prefsFile=${path}/Preferences;

   if [[ ! -f "$prefsFile" ]];
   then
        echo "Missing preferences file (${path})";
        continue;
   fi

   echo "-----------------------------------------------------------";
   echo "Profile: ${path}";
   echo "-----------------------------------------------------------";
   echo
   echo "Checking for left dead lock-files."
   find "${path}" -type f -name 'SingletonLock' -delete

   echo "Running profile-cleaner ..."
   profile-cleaner gc -p "${path}"
done

echo
echo "Done."
